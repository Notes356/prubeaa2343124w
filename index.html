<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaración Final</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Paleta extraída de tus imágenes */
            --c-bg-deep: #153548;    /* Fondo Profundo (Frío) */
            --c-bg-panel: #1A545D;   /* Paneles (Teal Oscuro) */
            --c-accent-love: #C61B24; /* Rojo/Rosa Apagado (Amor triste) */
            --c-text-mint: #9AE8B7;  /* Verde Menta (Luz fría) */
            --c-text-dim: #605056;   /* Púrpura grisáceo (Detalles) */
            --c-shadow: #0a131a;     /* Sombra negra azulada */
        }

        body {
            background-color: var(--c-bg-deep);
            font-family: 'VT323', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--c-text-mint);
            user-select: none;
        }

        /* Efecto CRT (Pantalla antigua) */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 6px 100%;
            pointer-events: none; z-index: 99;
        }

        /* Contenedores Pixel Art */
        .pixel-card {
            background: var(--c-bg-panel);
            border: 4px solid var(--c-shadow);
            padding: 2rem;
            width: 90%; max-width: 350px;
            text-align: center;
            position: relative;
            box-shadow: 
                inset 0 0 0 4px var(--c-bg-deep),
                8px 8px 0px var(--c-shadow);
        }

        .icon-heart {
            font-size: 40px; color: var(--c-accent-love);
            text-shadow: 2px 2px var(--c-shadow);
            margin-bottom: 10px;
            display: inline-block;
            animation: beat 3s infinite ease-in-out;
        }

        @keyframes beat { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        h1 { font-family: 'Press Start 2P', cursive; font-size: 16px; line-height: 1.5; margin-bottom: 1.5rem; color: #fff; text-shadow: 2px 2px var(--c-shadow); }
        p { font-size: 1.2rem; color: var(--c-text-mint); margin-bottom: 2rem; }

        /* Inputs y Botones */
        .pixel-input {
            background: var(--c-shadow);
            border: 2px solid var(--c-text-dim);
            color: var(--c-accent-love);
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 15px;
            width: 75%;
            text-align: center;
            outline: none;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .pixel-input:focus { border-color: var(--c-accent-love); }

        .pixel-btn {
            background: var(--c-accent-love);
            color: #fff;
            border: none;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 
                inset 2px 2px 0px rgba(255,255,255,0.3),
                inset -2px -2px 0px rgba(0,0,0,0.3),
                4px 4px 0px var(--c-shadow);
            transition: transform 0.1s;
        }
        .pixel-btn:active { transform: translate(4px, 4px); box-shadow: none; }
        
        .btn-small { padding: 8px 10px; font-size: 8px; margin-top: 10px; background: var(--c-text-dim); }

        /* Utilidades */
        .hidden { display: none !important; }
        .error-msg { color: var(--c-accent-love); margin-top: 15px; font-size: 14px; min-height: 20px; }
        
        /* Panel Admin */
        #admin-panel {
            display: none; position: absolute; z-index: 50;
            background: #000; border: 2px solid var(--c-accent-love);
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px; width: 300px;
        }
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; cursor: pointer; font-size: 20px; }
        .key-list { text-align: left; font-size: 14px; max-height: 100px; overflow-y: auto; margin: 15px 0; border: 1px dashed var(--c-text-dim); padding: 5px; }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <main class="pixel-card" id="view-login">
        <div class="icon-heart">❤</div>
        <h1>FRAGMENTOS<br>DE INVIERNO</h1>
        <p>Una llave, un uso.<br>Introduce el código.</p>
        
        <input type="text" id="user-key-input" class="pixel-input" placeholder="XXXX" maxlength="10">
        <button class="pixel-btn" id="btn-enter">ENTRAR</button>
        
        <div id="login-msg" class="error-msg"></div>
    </main>

    <main class="pixel-card hidden" id="view-content">
        <div class="icon-heart" style="color: var(--c-text-mint);">❄</div>
        <h1>ACCESO CONCEDIDO</h1>
        <p>"La llave se ha roto tras su uso.<br>Bienvenido al recuerdo."</p>
        
        <div style="border: 2px dashed var(--c-accent-love); padding: 15px;">
            <p style="color: #fff; font-size: 14px;">(Aquí irá la siguiente fase de tu página)</p>
        </div>
    </main>

    <div class="admin-trigger" id="btn-open-admin">⚙</div>

    <div id="admin-panel">
        <h2 style="font-family:'Press Start 2P'; font-size:12px; color:var(--c-accent-love); margin-bottom:20px;">PANEL MAESTRO</h2>
        
        <div id="admin-auth-view">
            <input type="password" id="admin-pass-input" class="pixel-input" placeholder="CLAVE MAESTRA">
            <button class="pixel-btn" id="btn-admin-login">ACCEDER</button>
        </div>

        <div id="admin-tools-view" class="hidden">
            <button class="pixel-btn" id="btn-generate">GENERAR LLAVE</button>
            <div id="keys-display" class="key-list">Cargando llaves...</div>
            <button class="pixel-btn btn-small" id="btn-close-admin">CERRAR</button>
        </div>
    </div>

    <script type="module">
        // 4.1 IMPORTAR FUNCIONES NECESARIAS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, update, get, onValue } 
            from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // 4.2 TU CONFIGURACIÓN (INTEGRADA)
        const firebaseConfig = {
            apiKey: "AIzaSyAnYkdRY_LhrJwpClgfWs38iP2mfxyc2tk",
            authDomain: "declaracion-final.firebaseapp.com",
            projectId: "declaracion-final",
            storageBucket: "declaracion-final.firebasestorage.app",
            messagingSenderId: "288671326547",
            appId: "1:288671326547:web:e549d8d79e951e408e41a6"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CONSTANTES ---
        const ADMIN_PASSWORD = "AMOR_FRIO"; // <--- ¡TU CLAVE PARA ENTRAR AL ADMIN!

        // --- REFERENCIAS DOM ---
        const viewLogin = document.getElementById('view-login');
        const viewContent = document.getElementById('view-content');
        const loginMsg = document.getElementById('login-msg');
        
        const adminPanel = document.getElementById('admin-panel');
        const adminAuthView = document.getElementById('admin-auth-view');
        const adminToolsView = document.getElementById('admin-tools-view');
        const keysDisplay = document.getElementById('keys-display');

        // --- 4.3 FUNCIONES DE USUARIO (ENTRAR) ---
        window.enterSystem = async () => {
            const keyInput = document.getElementById('user-key-input').value.trim().toUpperCase();
            
            if (!keyInput) {
                loginMsg.textContent = "Escribe algo...";
                return;
            }

            loginMsg.textContent = "Verificando en el frío...";

            // Referencia a la llave específica en la BD
            const keyRef = ref(db, 'llaves/' + keyInput);
            
            try {
                const snapshot = await get(keyRef);
                const data = snapshot.val();

                if (data && data.estado === "activa") {
                    // 1. LLAVE CORRECTA -> La marcamos como usada inmediatamente
                    await update(keyRef, {
                        estado: "usada",
                        usadaEn: new Date().toISOString()
                    });

                    // 2. Mostrar contenido
                    loginMsg.style.color = "var(--c-text-mint)";
                    loginMsg.textContent = "Llave aceptada.";
                    setTimeout(() => {
                        viewLogin.classList.add('hidden');
                        viewContent.classList.remove('hidden');
                    }, 1000);

                } else if (data && data.estado === "usada") {
                    loginMsg.style.color = "var(--c-accent-love)";
                    loginMsg.textContent = "Llave rota (ya usada).";
                } else {
                    loginMsg.style.color = "var(--c-accent-love)";
                    loginMsg.textContent = "La llave no existe.";
                }
            } catch (error) {
                console.error(error);
                loginMsg.textContent = "Error de conexión.";
            }
        };

        document.getElementById('btn-enter').addEventListener('click', window.enterSystem);

        // --- 4.4 FUNCIONES DE ADMIN (GESTIÓN) ---
        
        // Abrir/Cerrar Panel
        document.getElementById('btn-open-admin').addEventListener('click', () => {
            adminPanel.style.display = 'block';
        });
        document.getElementById('btn-close-admin').addEventListener('click', () => {
            adminPanel.style.display = 'none';
        });

        // Login Admin Local
        document.getElementById('btn-admin-login').addEventListener('click', () => {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === ADMIN_PASSWORD) {
                adminAuthView.classList.add('hidden');
                adminToolsView.classList.remove('hidden');
                startKeysListener(); // Empezar a ver llaves en tiempo real
            } else {
                alert("Acceso denegado");
            }
        });

        // Generar Nueva Llave
        document.getElementById('btn-generate').addEventListener('click', () => {
            const newKey = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            // Guardar en Firebase
            set(ref(db, 'llaves/' + newKey), {
                estado: "activa",
                creada: new Date().toISOString()
            });
            alert(`Llave creada: ${newKey}`);
        });

        // Escuchar cambios en la base de datos (Ver lista)
        function startKeysListener() {
            const allKeysRef = ref(db, 'llaves');
            onValue(allKeysRef, (snapshot) => {
                const data = snapshot.val();
                keysDisplay.innerHTML = "";
                
                if (!data) {
                    keysDisplay.innerHTML = "No hay llaves.";
                    return;
                }

                // Convertir objeto a array y mostrar
                Object.keys(data).forEach(key => {
                    const info = data[key];
                    const color = info.estado === 'activa' ? '#9AE8B7' : '#C61B24'; // Verde o Rojo
                    keysDisplay.innerHTML += `<div style="color:${color}; margin-bottom:5px;">
                        [${info.estado === 'activa' ? 'ACT' : 'USD'}] <b>${key}</b>
                    </div>`;
                });
            });
        }

    </script>
</body>
</html>
