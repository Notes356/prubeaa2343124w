<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fase 4: RPG Odisea (Corregido)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           SECCI√ìN CSS: VARIABLES GLOBALES Y RESET
           ========================================================================== */
        :root {
            --c-ui-border: #ffffff;
            --c-ui-bg: rgba(20, 20, 30, 0.95); /* Fondo UI un poco m√°s azulado */
            --c-accent: #f1c40f; /* Amarillo dorado */
            --c-danger: #e74c3c; /* Rojo peligro */
            --c-text-retro: #d0d0ff;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #050505;
            font-family: 'VT323', monospace;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* ==========================================================================
           SECCI√ìN CSS: EFECTOS DE PANTALLA (CRT Y PIXELACI√ìN)
           ========================================================================== */
        .pixel-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 900;
            /* Simulaci√≥n de scanlines y rejilla de pixeles */
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 4px 100%;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
            mix-blend-mode: overlay;
        }

        /* ==========================================================================
           SECCI√ìN CSS: MOTOR DEL MUNDO (SCROLL HORIZONTAL)
           ========================================================================== */
        #game-viewport {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
        }

        #world-track {
            display: flex; height: 100%; width: 400%; /* 4 Mundos en total */
            transition: transform 1.5s cubic-bezier(0.2, 0.8, 0.2, 1); /* Movimiento muy suave */
            will-change: transform;
        }

        .biome {
            width: 100vw; height: 100vh; position: relative;
            background-size: cover; background-position: center;
            overflow: hidden; image-rendering: pixelated; /* Fuerza look pixelado en fondos */
        }

        /* FONDOS CON FILTROS AMBIENTALES */
        #biome-1 { background-image: url('https://raw.githubusercontent.com/Notes356/NotasParsMIRO/4d63dd7f2a5b05f6bb427b8af684b1f44ed41824/Fase4/image-33.webp'); filter: contrast(1.1) saturate(0.8) brightness(0.9); }
        #biome-2 { background-image: url('https://raw.githubusercontent.com/Notes356/NotasParsMIRO/4d63dd7f2a5b05f6bb427b8af684b1f44ed41824/Fase4/image-35.webp'); filter: contrast(1.3) hue-rotate(5deg); }
        #biome-3 { background-image: url('https://raw.githubusercontent.com/Notes356/NotasParsMIRO/4d63dd7f2a5b05f6bb427b8af684b1f44ed41824/Fase4/image-39.webp'); filter: sepia(0.5) brightness(0.8) contrast(1.2); }
        #biome-4 { background-image: url('https://raw.githubusercontent.com/Notes356/NotasParsMIRO/4d63dd7f2a5b05f6bb427b8af684b1f44ed41824/Fase4/image-38.webp'); filter: grayscale(0.9) contrast(1.5) brightness(0.5) hue-rotate(280deg); }

        /* PART√çCULAS AMBIENTALES */
        .particle-container { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 10; }
        .particle { position: absolute; animation: floatPart var(--duration, 4s) infinite linear; opacity: 0.6; will-change: transform; }
        @keyframes floatPart { 
            0% { transform: translateY(0) rotate(0deg) scale(0.8); opacity:0; } 
            20% { opacity:1; } 
            100% { transform: translateY(-150px) rotate(var(--rot, 360deg)) scale(1.2); opacity:0; } 
        }

        /* ==========================================================================
           SECCI√ìN CSS: ENTIDADES (JUGADOR, FANTASMA, ITEMS)
           ========================================================================== */
        
        /* Sprite del Jugador */
        #player-char {
            position: absolute; bottom: 18%; left: 50%; transform: translateX(-50%);
            width: 140px; /* Un poco m√°s grande para presencia */
            z-index: 50; transition: filter 0.3s;
            image-rendering: pixelated;
            filter: drop-shadow(0 15px 10px rgba(0,0,0,0.7));
        }
        .anim-idle { animation: breathe 2.5s infinite ease-in-out; }
        .anim-walk { animation: walkJump 0.5s infinite alternate ease-in-out; }
        
        @keyframes breathe { 0%, 100% { transform: translateX(-50%) scaleY(1); } 50% { transform: translateX(-50%) scaleY(1.03); } }
        @keyframes walkJump { from { bottom: 18%; transform: translateX(-50%) rotate(-1deg); } to { bottom: 21%; transform: translateX(-50%) rotate(1deg); } }

        /* Sprite del Fantasma ("Yo") */
        #ghost-char {
            position: absolute; bottom: 22%; right: 18%; width: 130px;
            opacity: 0; transition: opacity 3s ease-in; 
            filter: grayscale(1) brightness(1.5) blur(1px) drop-shadow(0 0 15px white);
            pointer-events: none; image-rendering: pixelated; mix-blend-mode: hard-light;
            animation: ghostFloat 4s infinite ease-in-out alternate;
        }
        @keyframes ghostFloat { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* √çtems Interactivos (Burbujas) - POSICI√ìN CORREGIDA */
        .item-orb {
            position: absolute; 
            bottom: 45%; /* CORRECCI√ìN: Subido para que no lo tape el personaje */
            width: 64px; height: 64px;
            background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.8); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 32px;
            cursor: pointer; animation: floatOrb 2.5s infinite ease-in-out both;
            box-shadow: 0 0 25px rgba(255,255,255,0.3), inset 0 0 15px rgba(255,255,255,0.2);
            z-index: 40; /* Debajo del jugador pero accesible */
            backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
        }
        /* Desfase de animaci√≥n para que no se muevan igual */
        .item-orb:nth-child(2) { animation-delay: 0.5s; }
        .item-orb:nth-child(3) { animation-delay: 1s; }

        .item-orb:active { transform: scale(0.95) !important; background: rgba(255,255,255,0.3); }
        .item-orb.collected { animation: collectPop 0.6s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        
        @keyframes floatOrb { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        @keyframes collectPop { 
            0% { transform: scale(1); opacity:1; filter: brightness(1); } 
            50% { transform: scale(1.8); opacity:0.8; filter: brightness(2); } 
            100% { transform: scale(0); opacity:0; } 
        }

        /* ==========================================================================
           SECCI√ìN CSS: INTERFAZ DE USUARIO (HUD, DI√ÅLOGO, CONTROLES)
           ========================================================================== */
        #ui-layer { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            pointer-events:none; z-index: 950; /* Por encima de casi todo */
        }

        /* Barra Superior (HUD) */
        .top-bar {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between;
        }
        .retro-box {
            background: var(--c-ui-bg); border: 3px solid var(--c-ui-border);
            padding: 10px 15px; font-family: 'Press Start 2P'; font-size: 11px; color: var(--c-text-retro);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.6); text-transform: uppercase;
        }

        /* Caja de Di√°logo */
        #dialogue-panel {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 650px; min-height: 110px;
            background: var(--c-ui-bg); border: 4px solid var(--c-ui-border);
            padding: 18px; display: none; pointer-events: auto;
            color: white; font-size: 1.5rem; line-height: 1.3; text-shadow: 1px 1px 2px black;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .cursor-blink::after { content: '‚ñà'; animation: blink 0.8s infinite; color: var(--c-accent); margin-left: 5px;}

        /* Controles (Botones inferiores) */
        .controls-area {
            position: absolute; bottom: 25px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 25px;
            box-sizing: border-box; pointer-events: none;
        }
        .btn-move {
            pointer-events: auto; /* Los botones s√≠ reciben clicks */
            width: 75px; height: 75px; background: #ddd; border: 4px solid #444;
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 30px; color: #333; opacity: 0.8; cursor: pointer;
            box-shadow: 0 6px 0 #222, 0 10px 20px rgba(0,0,0,0.4); transition: all 0.1s;
        }
        .btn-move:active { transform: translateY(6px); box-shadow: 0 0px 0 #222, 0 5px 10px rgba(0,0,0,0.4); opacity: 1; background: #fff; }
        .btn-move:disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* ==========================================================================
           SECCI√ìN CSS: MINIJUEGO FINAL (COLAPSO) Y PANTALLAS
           ========================================================================== */
        #collapse-system {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: 980;
            background: rgba(15, 5, 5, 0.96); display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #heart-btn {
            font-size: 130px; color: var(--c-danger); filter: drop-shadow(0 0 30px var(--c-danger));
            animation: pulseCritical 0.6s infinite; cursor: pointer; user-select: none;
            transition: transform 0.1s;
        }
        #heart-btn:active { transform: scale(0.85); filter: brightness(1.5); }
        
        .hp-bar-frame { width: 300px; height: 24px; border: 3px solid #777; background: #222; margin-top: 30px; padding: 3px; }
        .hp-fill { width: 50%; height: 100%; background: linear-gradient(to right, var(--c-danger), #ff5555); transition: width 0.1s linear; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        .glitch-txt {
            position: absolute; font-family: 'Press Start 2P'; color: var(--c-danger);
            font-size: 14px; animation: glitchAnim 0.25s infinite steps(2); pointer-events: none;
            text-shadow: 2px 2px 0 black;
        }

        /* Animaciones Auxiliares */
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulseCritical { 0% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.15); opacity: 1; } 100% { transform: scale(1); opacity: 0.9; } }
        @keyframes glitchAnim { 0% { transform: translate(0); clip-path: inset(0 0 0 0); } 25% { transform: translate(-3px, 2px); clip-path: inset(10% 0 40% 0); } 50% { transform: translate(3px, -2px); clip-path: inset(40% 0 10% 0); } 75% { transform: translate(-3px, -2px); clip-path: inset(20% 0 20% 0); } }

        /* Pantalla de Inicio */
        #intro-screen {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="pixel-overlay"></div>

    <div id="intro-screen" onclick="Game.start()">
        <h1 style="font-family:'Press Start 2P'; color:var(--c-accent); font-size:18px; margin-bottom:25px; text-shadow: 3px 3px 0 #555;">FASE 4</h1>
        <p style="font-family:'VT323'; font-size: 28px; color: var(--c-text-retro);">REALIDADES CRUZADAS</p>
        <div style="margin-top:50px; font-size: 16px; animation:blink 1s infinite; font-family:'Press Start 2P'; color:#aaa;">[ CLIC PARA INICIAR ]</div>
    </div>

    <div id="game-viewport">
        <div id="world-track">
            
            <div class="biome" id="biome-1">
                <div class="particle-container" id="fx-1"></div>
                <div class="item-orb" style="left:20%;" onclick="Game.interact(0, 'Mis guardias son eternas... estudio para salvar vidas, pero a veces olvido vivir la m√≠a.', 0)">ü©∫</div>
                <div class="item-orb" style="left:50%;" onclick="Game.interact(1, 'Libros, ex√°menes, presi√≥n. Mi futuro depende de esto.', 0)">üìö</div>
                <div class="item-orb" style="left:80%;" onclick="Game.interact(2, 'Amo mi carrera, pero... ¬øhay espacio para algo m√°s?', 0)">üíä</div>
            </div>

            <div class="biome" id="biome-2">
                <div class="particle-container" id="fx-2"></div>
                <div class="item-orb" style="left:25%;" onclick="Game.interact(3, 'Mis amigos me dan la libertad que necesito.', 1)">üçª</div>
                <div class="item-orb" style="left:55%;" onclick="Game.interact(4, 'Me da miedo perder mi independencia por una relaci√≥n.', 1)">üèôÔ∏è</div>
                <div class="item-orb" style="left:85%;" onclick="Game.interact(5, 'Aqu√≠ soy yo misma. Sin etiquetas.', 1)">üéµ</div>
            </div>

            <div class="biome" id="biome-3">
                <div class="particle-container" id="fx-3"></div>
                <img id="ghost-char" src="https://raw.githubusercontent.com/Notes356/NotasParsMIRO/e643d2de9ed5e76f941ee538f8fd07d351823ccb/Im%C3%A1genesA/Yo_pixelart.webp">
                <div class="item-orb" style="left:30%; border-color:var(--c-accent);" onclick="Game.interact(6, 'Te quer√≠a... te quer√≠a tanto. Eras mi lugar seguro.', 2)">üåπ</div>
                <div class="item-orb" style="left:60%; border-color:var(--c-accent);" onclick="Game.interact(7, 'Pero mis dudas eran m√°s fuertes que mi coraz√≥n.', 2)">üí≠</div>
                <div class="item-orb" style="left:90%; border-color:var(--c-accent);" onclick="Game.interact(8, '¬øFue la distancia? ¬øFue el dinero? ¬øO fui yo?', 2)">‚úâÔ∏è</div>
            </div>

            <div class="biome" id="biome-4">
                <div class="particle-container" id="fx-4"></div>
                <div style="position:absolute; top:40%; width:100%; text-align:center; color:var(--c-danger); font-family:'Press Start 2P'; font-size:16px; text-shadow:2px 2px black; animation: glitchAnim 0.5s infinite steps(3);">ERROR CR√çTICO DE V√çNCULO</div>
            </div>

        </div>

        <img id="player-char" class="anim-idle" src="">
    </div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="retro-box">LUGAR: <span id="loc-txt" style="color:var(--c-accent)">FACULTAD</span></div>
            <div class="retro-box">PROGRESO: <span id="prog-txt">0/3</span></div>
        </div>

        <div id="dialogue-panel"></div>

        <div class="controls-area">
            <button id="btn-left" class="btn-move" disabled onclick="Game.move(-1)">‚óÄ</button>
            <button id="btn-right" class="btn-move" disabled onclick="Game.move(1)">‚ñ∂</button>
        </div>
    </div>

    <div id="collapse-system">
        <h2 style="color:var(--c-text-retro); font-family:'Press Start 2P'; font-size:14px; margin-bottom:40px; text-align:center; line-height: 1.5;">SISTEMA FALLANDO<br><span style="color:var(--c-danger)">SOST√âN EL V√çNCULO</span></h2>
        <div id="heart-btn" onclick="FinalGame.pump()">‚ù§</div>
        <div class="hp-bar-frame">
            <div class="hp-fill" id="hp-val"></div>
        </div>
    </div>

    <audio id="bg-ost" loop>
        <source src="https://raw.githubusercontent.com/Notes356/NotasParsMIRO/4d63dd7f2a5b05f6bb427b8af684b1f44ed41824/Fase4/pixel-dreams-259187.ogg" type="audio/ogg">
    </audio>

    <script>
        // === CONFIGURACI√ìN DE SPRITES (Invertidos seg√∫n instrucci√≥n) ===
        // SPRITE 1 (Inicio - Triste/Mirando abajo)
        const SPRITE_START_PHASE_1_2 = "https://raw.githubusercontent.com/Notes356/NotasParsMIRO/b32ef0a23b35cffc8d5362ac0476cdb1bed418de/Fase4/Picsart_26-02-03_12-01-14-752.webp";
        // SPRITE 2 (Despu√©s - Normal/Mirando al frente)
        const SPRITE_LATER_PHASE_3_4 = "https://raw.githubusercontent.com/Notes356/NotasParsMIRO/b32ef0a23b35cffc8d5362ac0476cdb1bed418de/Fase4/Picsart_26-02-03_11-41-34-090.webp";

        // === MOTOR DE AUDIO ===
        const AudioFx = {
            ctx: null,
            init() { const AC = window.AudioContext || window.webkitAudioContext; this.ctx = new AC(); },
            beep(f, t, v=0.1, d=0.1) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
                g.gain.setValueAtTime(v, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + d);
            }
        };

        // === MOTOR DEL JUEGO PRINCIPAL (RPG) ===
        const Game = {
            world: 0,
            items: [0, 0, 0],
            totalItems: 3,
            isMoving: false,

            start() {
                document.getElementById('intro-screen').style.display = 'none';
                AudioFx.init();
                const ost = document.getElementById('bg-ost');
                ost.volume = 0.4; ost.play();
                
                // Establecer sprite inicial (Triste)
                document.getElementById('player-char').src = SPRITE_START_PHASE_1_2;
                
                this.spawnParticles(0);
                this.updateUI();
            },

            move(dir) {
                if(this.isMoving) return;
                const next = this.world + dir;
                
                if(next >= 0 && next <= 3) {
                    this.isMoving = true;
                    this.world = next;
                    AudioFx.beep(300, 'triangle', 0.2); // Sonido de paso
                    
                    const charImg = document.getElementById('player-char');
                    
                    // CAMBIO DE SPRITE (L√≥gica Invertida: Triste -> Normal)
                    if(this.world >= 2) { 
                        // Mundos 3 y 4: Usar el segundo sprite (Normal)
                        if(charImg.src !== SPRITE_LATER_PHASE_3_4) charImg.src = SPRITE_LATER_PHASE_3_4;
                    } else {
                        // Mundos 1 y 2: Usar el primer sprite (Triste)
                        if(charImg.src !== SPRITE_START_PHASE_1_2) charImg.src = SPRITE_START_PHASE_1_2;
                    }

                    // Animaci√≥n de caminar
                    charImg.classList.remove('anim-idle');
                    charImg.classList.add('anim-walk');

                    // Desplazar el mundo
                    document.getElementById('world-track').style.transform = `translateX(-${this.world * 100}vw)`;

                    // Finalizar movimiento
                    setTimeout(() => {
                        this.isMoving = false;
                        charImg.classList.remove('anim-walk');
                        charImg.classList.add('anim-idle');
                        this.spawnParticles(this.world);
                        this.updateUI();
                        
                        // Triggers de eventos
                        if(this.world === 3) setTimeout(() => this.startCollapse(), 1000);
                        
                        if(this.world === 2) {
                            document.getElementById('ghost-char').style.opacity = '0.5';
                            AudioFx.beep(1200, 'sine', 0.05, 0.5); // Sonido et√©reo
                        } else {
                            document.getElementById('ghost-char').style.opacity = '0';
                        }

                    }, 1500); // Tiempo coordinado con la transici√≥n CSS
                }
            },

            interact(id, text, worldId) {
                const el = document.querySelectorAll('.item-orb')[id];
                if(el.classList.contains('collected')) return;

                el.classList.add('collected');
                // Sonido de recolecci√≥n "retro" escalonado
                AudioFx.beep(600 + (id*100), 'square', 0.1, 0.15);
                setTimeout(() => AudioFx.beep(800 + (id*100), 'square', 0.1, 0.15), 100);

                this.items[worldId]++;
                this.showDialog(text);
                this.updateUI();
            },

            showDialog(txt) {
                const box = document.getElementById('dialogue-panel');
                box.style.display = 'block';
                box.innerHTML = '<span class="cursor-blink"></span>';
                let i = 0;
                if(this.typeTimer) clearInterval(this.typeTimer);
                
                this.typeTimer = setInterval(() => {
                    if(i < txt.length) {
                        // Insertar antes del cursor
                        box.lastChild.insertAdjacentText('beforebegin', txt.charAt(i));
                        i++;
                        if(i%3===0) AudioFx.beep(200, 'noise', 0.02, 0.05); // Sonido de tecleo suave
                    } else {
                        clearInterval(this.typeTimer);
                        setTimeout(() => box.style.display = 'none', 4000);
                    }
                }, 35);
            },

            updateUI() {
                const names = ["FACULTAD", "CIUDAD", "MEMORIA", "COLAPSO"];
                document.getElementById('loc-txt').innerText = names[this.world];
                document.getElementById('prog-txt').innerText = `${this.items[this.world]}/${this.totalItems}`;

                const btnNext = document.getElementById('btn-right');
                const btnPrev = document.getElementById('btn-left');

                btnPrev.disabled = (this.world === 0);
                
                if(this.world < 3) {
                    // Habilitar bot√≥n siguiente solo si se recolectaron los 3 items
                    const completed = (this.items[this.world] === this.totalItems);
                    btnNext.disabled = !completed;
                    
                    if(completed) {
                        btnNext.style.borderColor = "var(--c-accent)";
                        btnNext.style.background = "#fff";
                        if(!btnNext.classList.contains('ready')) {
                             AudioFx.beep(1500, 'sine', 0.2, 0.3); // Sonido "Ready"
                             btnNext.classList.add('ready');
                        }
                    } else {
                        btnNext.style.borderColor = "#444";
                        btnNext.style.background = "#ddd";
                        btnNext.classList.remove('ready');
                    }
                }
            },

            spawnParticles(w) {
                document.querySelectorAll('.particle-container').forEach(c => c.innerHTML='');
                const container = document.getElementById(`fx-${w+1}`);
                if(!container) return;

                const configs = [
                    {sym: '‚úö', col: '#a8e6cf', rot: '45deg'}, // Facultad
                    {sym: '‚ô´', col: '#ff6b81', rot: '-45deg'}, // Ciudad
                    {sym: '‚ùÄ', col: '#f1c40f', rot: '180deg'}, // Memoria
                    {sym: '‚ö°', col: '#ff0000', rot: '90deg'}  // Colapso
                ];
                const cfg = configs[w];

                for(let i=0; i<18; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.innerText = cfg.sym;
                    p.style.color = cfg.col;
                    p.style.left = Math.random()*100+'%';
                    p.style.top = Math.random()*100+'%';
                    p.style.fontSize = (12+Math.random()*18)+'px';
                    // Variables CSS personalizadas para la animaci√≥n
                    p.style.setProperty('--duration', (4+Math.random()*3)+'s');
                    p.style.setProperty('--rot', cfg.rot);
                    container.appendChild(p);
                }
            },

            startCollapse() {
                document.getElementById('ui-layer').style.display = 'none'; // Ocultar HUD
                const ost = document.getElementById('bg-ost');
                // Efecto de ralentizaci√≥n de m√∫sica
                let rate = 1.0;
                const slowDown = setInterval(() => {
                    if(rate > 0.7) { rate -= 0.05; ost.playbackRate = rate; }
                    else { clearInterval(slowDown); }
                }, 200);
                
                AudioFx.beep(100, 'sawtooth', 0.3, 1.0); // Sonido de alarma grave
                FinalGame.init();
            }
        };

        // === MINIJUEGO FINAL (COLAPSO) ===
        const FinalGame = {
            hp: 50, active: false,
            init() {
                document.getElementById('collapse-system').style.display = 'flex';
                this.active = true;
                this.loop();
                this.glitchSpawner();
            },
            pump() {
                if(!this.active) return;
                this.hp = Math.min(100, this.hp + 14);
                AudioFx.beep(180, 'square', 0.2, 0.1); // Sonido latido fuerte
                const h = document.getElementById('heart-btn');
                h.style.transform = "scale(1.3)";
                setTimeout(() => h.style.transform = "scale(1)", 50);
            },
            loop() {
                if(!this.active) return;
                this.hp -= 0.38; // Drenaje constante
                const fill = document.getElementById('hp-val');
                fill.style.width = Math.max(0, this.hp) + '%';
                
                // Cambio de color seg√∫n estado
                if(this.hp < 25) fill.style.background = "#fff";
                else fill.style.background = "linear-gradient(to right, var(--c-danger), #ff5555)";

                if(this.hp > 98) this.end(true);
                if(this.hp <= 0) { 
                    this.hp = 60; 
                    AudioFx.beep(50, 'noise', 0.3, 0.2); // Ruido de fallo
                }
                
                requestAnimationFrame(() => this.loop());
            },
            glitchSpawner() {
                if(!this.active) return;
                const words = ["ERROR", "TE PIERDO", "DUDAS", "MIEDO", "SISTEMA CA√çDO"];
                const el = document.createElement('div'); el.className='glitch-txt';
                el.innerText = words[Math.floor(Math.random()*words.length)];
                el.style.left = Math.random()*85+5+'%';
                el.style.top = Math.random()*85+5+'%';
                document.getElementById('collapse-system').appendChild(el);
                setTimeout(()=>el.remove(), 700);
                setTimeout(()=>this.glitchSpawner(), 900 + Math.random()*500);
            },
            end() {
                this.active = false;
                document.body.style.transition = "opacity 2.5s ease-out";
                document.body.style.opacity = "0";
                // Fade out m√∫sica
                const ost = document.getElementById('bg-ost');
                let vol = ost.volume;
                const fade = setInterval(() => { if(vol>0) {vol-=0.05; ost.volume=vol;} else clearInterval(fade); }, 150);

                setTimeout(() => {
                    // AQU√ç IR√çA LA REDIRECCI√ìN A LA FASE 5
                    (window.location.href = 'fase5.html');
                }, 3000);
            }
        };
    </script>
</body>
</html>
